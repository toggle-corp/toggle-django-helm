suite: config secret
templates:
  - templates/config/secret.yaml
tests:
  - it: should render Secret with expected metadata and stringData (tpl evaluated)
    set:
      environment: TEST
      secretsStoreCsiDriver:
        create: false
      # values used by tpl in secrets
      postgresql:
        auth:
          database: "my-app"
          postgresPassword: "random-strong-password"
      secrets:
        SIMPLE: plain
        POSTGRES_DB: "{{ .Values.postgresql.auth.database }}"
        POSTGRES_USER: "postgres"
        POSTGRES_PASSWORD: "{{ .Values.postgresql.auth.postgresPassword }}"

    asserts:
      - isKind:
          of: Secret
      - isAPIVersion:
          of: v1
      - isNotEmpty:
          path: metadata.name
      - equal:
          path: metadata.labels.environment
          value: TEST
      - equal:
          path: metadata.labels.release
          value: RELEASE-NAME
      - isNotEmpty:
          path: metadata.labels.app
      - equal:
          path: type
          value: Opaque
      - equal:
          path: stringData.SIMPLE
          value: "plain"
      - equal:
          path: stringData.POSTGRES_DB
          value: "my-app"
      - equal:
          path: stringData.POSTGRES_PASSWORD
          value: "random-strong-password"

  - it: should not render Secret when secretsStoreCsiDriver.create=true (Azure Key Vault enabled)
    set:
      secretsStoreCsiDriver:
        create: true
      secrets:
        SIMPLE: plain
    asserts:
      - hasDocuments:
          count: 0

  - it: should render Secret with empty stringData when secrets is empty
    set:
      environment: TEST
      secretsStoreCsiDriver:
        create: false
      secrets: {}
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.labels.environment
          value: TEST
      - equal:
          path: stringData
          value: null
