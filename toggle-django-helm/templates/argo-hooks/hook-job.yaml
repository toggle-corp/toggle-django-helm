{{- if .Values.argoHook.enabled }}

{{- range $hookName, $hook := .Values.argoHook.hooks }}

{{- if $hook.enabled }}

---
apiVersion: batch/v1
kind: Job
metadata:
  {{- if $hook.preserveHistory }}
  generateName: {{ template "django-app.fullname" $ }}-{{ $hookName }}-
  {{- else }}
  name: {{ template "django-app.fullname" $ }}-{{ $hookName }}
  {{- end }}
  annotations:
    argocd.argoproj.io/hook: {{ $hook.hook }}
spec:
  template:
    metadata:
      annotations:
        {{- include "django-app.appDefaultAnnotations" $ | nindent 8 }}
      labels:
        app: {{ include "django-app.fullname" $ }}
        component: argo-hooks
        {{- with (include "django-app.appDefaultLabels" $) -}}{{ . | nindent 8 }}{{- end }}
    spec:
      restartPolicy: "Never"
      {{- with (include "django-app.appDefaultVolumes" $) -}}{{ . | nindent 6 }}{{- end }}
      {{- if $.Values.serviceAccount.create }}
      serviceAccountName: {{ include "django-app.serviceAccountName" $ }}
      {{- end }}
      containers:
        - name: {{ $hookName }}
          {{- include "django-app.imageConfig"
              (dict "Default" $.Values.image "Override" $.Values.argoHook.image)
              | nindent 10
          }}
          command: {{ toYaml $hook.command | trim | nindent 12 }}
          {{- if $hook.args }}
          args: {{ toYaml $hook.args | trim | nindent 12 }}
          {{- end }}
          resources:
            {{- include "django-app.resourcesConfig"
                (dict "Default" $.Values.argoHook.resources "Override" $hook.resources)
                | nindent 12
            }}
          envFrom:
            {{- include "django-app.envFromTemplate" $ | nindent 12 }}
          env:
            {{- include "django-app.envTemplate"
                (dict "Values" $.Values "Type" "hook" )
                | nindent 12
            }}

{{- end }}

{{- end }}

{{- end }}
